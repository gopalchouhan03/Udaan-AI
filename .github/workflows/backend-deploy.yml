name: Deploy Backend to EC2

on:
  push:
    branches:
      - main

env:
  APP_NAME: udaan-backend
  BACKEND_DIR: udaan-ai/backend
  HEALTH_CHECK_URL: http://43.204.101.167:5000/api/health
  HEALTH_CHECK_TIMEOUT: 60

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    concurrency:
      group: backend-deployment
      cancel-in-progress: false
    environment: production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          HOST="${{ secrets.EC2_HOST }}"
          USER="${{ secrets.EC2_USER }}"
          KEY="${{ secrets.EC2_SSH_KEY }}"
          
          if [ -z "$HOST" ] || [ -z "$USER" ] || [ -z "$KEY" ]; then
            echo "‚ùå Error: Required secrets are not configured:"
            [ -z "$HOST" ] && echo "  - EC2_HOST"
            [ -z "$USER" ] && echo "  - EC2_USER"
            [ -z "$KEY" ] && echo "  - EC2_SSH_KEY"
            exit 1
          fi
          echo "‚úì All required secrets are configured"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            echo "üìÇ Checking backend directory..."
            if [ ! -d "${{ env.BACKEND_DIR }}" ]; then
              echo "‚ùå Error: Backend directory not found at ${{ env.BACKEND_DIR }}"
              exit 1
            fi
            
            cd ${{ env.BACKEND_DIR }} || exit 1
            
            echo "üîÑ Pulling latest code..."
            git pull origin main --ff-only || {
              echo "‚ùå Git pull failed"
              exit 1
            }
            
            echo "üì¶ Installing dependencies..."
            npm ci --prefer-offline || {
              echo "‚ùå npm install failed"
              exit 1
            }
            
            echo "‚úì Dependencies installed"
            
            echo "üöÄ Restarting backend service..."
            if pm2 list | grep -q "${{ env.APP_NAME }}"; then
              pm2 restart ${{ env.APP_NAME }} || {
                echo "‚ö†Ô∏è  Restart failed, attempting fresh start..."
                pm2 start server.js --name "${{ env.APP_NAME }}" || exit 1
              }
            else
              echo "üìå Starting new PM2 process..."
              pm2 start server.js --name "${{ env.APP_NAME }}" || exit 1
            fi
            
            pm2 save || echo "‚ö†Ô∏è  PM2 save failed (non-critical)"
            
            echo "‚úì Backend service started"
            echo ""
            echo "üìä PM2 Status:"
            pm2 list

      - name: Health Check
        run: |
          echo "üè• Performing health check..."
          ELAPSED=0
          TIMEOUT=${{ env.HEALTH_CHECK_TIMEOUT }}
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.HEALTH_CHECK_URL }} 2>/dev/null || echo "000")
            
            if [ "$RESPONSE" = "200" ]; then
              echo "‚úÖ Health check passed (HTTP $RESPONSE)"
              exit 0
            fi
            
            echo "‚è≥ Health check failed (HTTP $RESPONSE), retrying... ($ELAPSED/$TIMEOUT seconds)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          echo "‚ùå Health check timeout after $TIMEOUT seconds"
          exit 1
        continue-on-error: true

      - name: Verify Deployment
        run: |
          echo "üîç Verifying deployment status..."
          ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "cd ${{ env.BACKEND_DIR }} && npm list --depth=0" || echo "‚ö†Ô∏è  Dependency check skipped"

      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Backend deployment successful!"
          echo "üñ•Ô∏è  EC2 Host: ${{ secrets.EC2_HOST }}"
          echo "üìç Backend API: http://${{ secrets.EC2_HOST }}:5000"
          echo "üîÑ App Status: Running via PM2"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Backend deployment failed!"
          echo "Check EC2 instance logs:"
          echo "  ssh -i key.pem ec2-user@${{ secrets.EC2_HOST }}"
          echo "  pm2 logs ${{ env.APP_NAME }}"
          exit 1
