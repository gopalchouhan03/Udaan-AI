name: Deploy Frontend to AWS S3

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-south-1
  NODE_VERSION: 18

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    concurrency:
      group: frontend-deployment
      cancel-in-progress: false

    steps:
      # ---------------------------
      # 1. Checkout Code
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------
      # 2. Validate Required Secrets
      # ---------------------------
      - name: Validate secrets
        run: |
          echo "üîç Validating required secrets..."
          [ -z "${{ secrets.S3_BUCKET_NAME }}" ] && echo "‚ùå Missing S3_BUCKET_NAME" && exit 1
          [ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ] && echo "‚ùå Missing CLOUDFRONT_DISTRIBUTION_ID" && exit 1
          [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && echo "‚ùå Missing AWS_ACCESS_KEY_ID" && exit 1
          [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] && echo "‚ùå Missing AWS_SECRET_ACCESS_KEY" && exit 1
          [ -z "${{ secrets.VITE_API_URL }}" ] && echo "‚ùå Missing VITE_API_URL" && exit 1
          echo "‚úÖ All required secrets are present"

      # ---------------------------
      # 3. Setup Node.js
      # ---------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # ---------------------------
      # 4. Install Dependencies
      # ---------------------------
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      # ---------------------------
      # 5. Build Frontend (IMPORTANT FIX)
      # ---------------------------
      - name: Build frontend with correct API URL
        run: |
          cd frontend
          echo "üöÄ Building frontend with API URL: $VITE_API_URL"
          npm run build
        env:
          CI: true
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      # ---------------------------
      # 6. Verify Build Output
      # ---------------------------
      - name: Verify build output
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå Build failed: dist directory not found"
            exit 1
          fi
          if [ -z "$(ls -A frontend/dist)" ]; then
            echo "‚ùå Build failed: dist directory is empty"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      # ---------------------------
      # 7. Deploy to S3
      # ---------------------------
      - name: Deploy to S3
        run: |
          echo "üì§ Syncing static assets to S3..."
          aws s3 sync frontend/dist s3://${{ secrets.S3_BUCKET_NAME }} \
            --delete \
            --cache-control "public, max-age=3600" \
            --exclude "index.html"

          echo "üìÑ Uploading index.html with no-cache headers..."
          aws s3 cp frontend/dist/index.html s3://${{ secrets.S3_BUCKET_NAME }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html"

          echo "‚úÖ S3 deployment completed"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}

      # ---------------------------
      # 8. Invalidate CloudFront Cache
      # ---------------------------
      - name: Invalidate CloudFront cache
        run: |
          echo "üîÑ Creating CloudFront invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "üÜî Invalidation ID: $INVALIDATION_ID"
          echo "‚è≥ Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --id $INVALIDATION_ID

          echo "‚úÖ CloudFront cache invalidated"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}

      # ---------------------------
      # 9. Deployment Summary
      # ---------------------------
      - name: Deployment summary
        if: success()
        run: |
          echo "üéâ Frontend deployment successful!"
          echo "üåç Frontend URL: https://d2i4w0tbngbtdf.cloudfront.net"
          echo "ü™£ S3 Bucket: s3://${{ secrets.S3_BUCKET_NAME }}"
          echo "üîó API URL used: ${{ secrets.VITE_API_URL }}"
